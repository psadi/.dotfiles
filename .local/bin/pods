#!/usr/bin/env bash
# vim: ft=bash sw=2 ts=2 et

set -euo pipefail

export GUM_CHOOSE_TIMEOUT=10s

# Display header
gum style \
  --foreground 212 --border-foreground 212 --border normal \
  --align center --width 50 --margin "1 2" --padding "1 2" \
  'Podman | Systemctl - Container Management'

ACTION="$(gum choose --limit=1 --header="Select target action to perform: " "logs" "ps" "restart" "start" "status" "stop")"

if [[ $ACTION != "ps" ]]; then
  SERVICES="$(find ~/.config/systemd/user/ -type f | awk -F '/' '{gsub(/\.service$/, "", $NF); print $NF}' | xargs )"
  SERVICE="$(gum choose --limit=1 --header "Container Service to '"$ACTION"'" $SERVICES)"
fi

case $ACTION in
  ps)
    podman ps --format 'table {{.ID}},{{.Names}},{{.Ports}},{{.Status}}' | gum table -p --border.foreground="212"
    ;;
  status)
    systemctl --user --no-pager status "$SERVICE"
    ;;
  logs)
    podman logs "$SERVICE" || exit 0
    ;;
  start|stop|restart)
    gum spin --title "Performing Action: '$ACTION' for Service: '$SERVICE'" -- systemctl --user "$ACTION" "$SERVICE"
    ;;
  *)
    gum log -l error "Invalid Action: '$ACTION'"
    ;;
esac

